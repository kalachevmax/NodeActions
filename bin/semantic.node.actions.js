var fs = require('fs');var path = require('path');var crypto = require('crypto');var child_process = require('child_process');var fm = require('../../semantic.fm/bin/semantic.fm.js');var dm = require('../../semantic.dm/bin/semantic.dm.js');var am = require('../../semantic.am/bin/semantic.am.js');var act={fs:{}};act.fs.dir={};act.fs.dir.get={};act.fs.file={};act.fs.files={};act.fs.tree={};act.fs.node={};act.fs.node.is={};act.fs.stream={};act.proc={};act.hash={};act.dm={};act.dm.symbol={};act.Type={FILE:"FILE",DIR:"DIRECTORY",FILE_CONTENT:"FILE_CONTENT"};act.fs.TypeProvider=function(){};act.fs.TypeProvider.prototype.getDefaultValue=function(b){switch(b){case act.Type.FILE_CONTENT:return""}return null};act.fs.TypeProvider.prototype.typeof=function(b,c){switch(c){case act.Type.FILE_CONTENT:return"string"===typeof b||b instanceof Buffer}return!1};
act.fs.TypeProvider.prototype.assert=function(b,c,a){return function(d,e,f){function g(){"string"===typeof a?act.fs.node.is.directory(function(a){a?d(f):e("[act.fs.TypeProvider] value type for symbol + "+b+"is not "+c)},e,a):e("[act.fs.TypeProvider] type of path "+a+" is not "+dm.Type.STRING)}function h(){"string"===typeof a?act.fs.node.exists(function(a){a?d(f):e("[TypeProvider] value type for symbol + "+b+"is not "+c)},e,a):e("[act.fs.TypeProvider] type of path "+a+" is not "+dm.Type.STRING)}switch(c){case act.Type.DIR:g();
break;case act.Type.FILE:h();break;case act.Type.FILE_CONTENT:d("string"===typeof a||a instanceof Buffer);break;default:e("[act.fs.TypeProvider] type "+c+" for symbol + "+b+"is not defined")}}};act.fs.TypeProvider.prototype.createLink=function(b,c,a){switch(c){case act.Type.FILE:return new act.fs.FileLink(a);case act.Type.DIR:return new act.fs.DirectoryLink(a)}return null};act.dm.Entity=function(b,c){dm.Entity.call(this,b,c)};utils.inherit(act.dm.Entity,dm.Entity);act.dm.Entity.prototype.fileContent=function(b,c){this.setField(b,new act.dm.symbol.FileContent(b,c))};act.dm.EntityType={FILE:"file",DIR:"dir"};act.dm.File=function(){dm.Entity.call(this,dm.EntityType.FILE);this.string("path");this.fileContent("content");this.string("encoding","utf8");this.number("mode",438);this.string("flag","w")};utils.inherit(act.dm.File,dm.Entity);act.dm.File.prototype.populate=function(b){this.set("path",b.path);this.set("content",b.content);this.set("encoding",b.encoding);this.set("mode",b.mode);this.set("flag",b.flag)};act.dm.File.prototype.getPath=function(){return this.getField("path").getValue()};
act.dm.File.prototype.getContent=function(){return this.getField("content").getValue()};act.dm.File.prototype.getOptions=function(){return{encoding:this.getField("encoding").getValue(),mode:this.getField("mode").getValue(),flag:this.getField("flag").getValue()}};act.dm.symbol.FileContent=function(b,c){dm.symbol.Atom.call(this,b,act.Type.FILE_CONTENT,c)};utils.inherit(act.dm.symbol.FileContent,dm.symbol.Atom);dm.new.file=function(){};act.fs.dir.create=function(b,c,a){fs.mkdir(a,function(a){null===a?b():c("[act.fs.dir.create] "+a.toString())})};act.fs.dir.remove=function(b,c,a){fs.rmdir(a,function(a){null===a?b():c("[act.fs.dir.remove] "+a.toString())})};act.fs.dir.read=function(b,c,a){fs.readdir(a,function(a,e){null===a?b(e):c("[act.fs.dir.read] "+a.toString())})};
act.fs.dir.readTree=function(b,c,a){function d(a){return function(b,c,d){k.push(a);b(d)}}function e(a,b){k.pop();a()}function f(a,b,c){l.push(c);a()}function g(a,b,c){fm.script([act.fs.dir.read,fm.each(h),e])(a,b,c)}function h(a,b,c){var e=path.join(k.join("/"),c);fm.script([fm.if(act.fs.is.directory,fm.script([d(c),g]),f)])(a,b,e)}var k=[],l=[];fm.script([d(a),g])(function(){b(l)},c,a)};
act.fs.dir.removeTree=function(b,c,a){function d(a){return function(b,c,d){h.push(a);b(d)}}function e(a,b){var c=path.join(h.join("/"));act.fs.dir.remove(function(){h.pop();a()},b,c)}function f(a,b,c){fm.script([act.fs.dir.read,fm.each(g),e])(a,b,c)}function g(a,b,c){var e=path.join(h.join("/"),c);fm.script([fm.if(act.fs.node.is.directory,fm.script([d(c),f]),act.fs.file.safeRemove)])(a,b,e)}var h=[];fm.script([d(a),f])(function(){b()},c,a)};act.fs.dir.get.nested=fm.script([dm.arg.str("path"),dm.def.array("dirs"),act.fs.dir.read,fm.each(fm.script([dm.set.str("node"),fm.if(act.fs.node.is.directory,fm.script([dm.array("dirs"),dm.act.array.push("node")]))])),dm.ret.array("dirs")]);act.fs.file.read=function(b,c,a){fs.readFile(a.getPath(),a.getOptions(),function(a,e){null===a?b(e):c("[act.fs.file.read] "+a.toString())})};act.fs.file.remove=function(b,c,a){fs.unlink(a,function(d){null===d?b(a):c("[act.fs.file.remove] "+d.toString())})};act.fs.file.safeRemove=function(b,c,a){act.fs.file.remove(b,function(){fm.script([act.fs.node.chmod(511),act.fs.file.remove])(function(){b(a)},c,a)},a)};
act.fs.file.write=function(b,c,a){fs.writeFile(a.getPath(),a.getContent(),a.getOptions(),function(d){null===d?b(a):c("[act.fs.file.write]: "+d.toString())})};act.fs.file.append=function(b,c,a){};act.fs.node.exists=function(b,c,a){fs.exists(a,function(a){b(a)})};act.fs.node.chmod=function(b){return function(c,a,d){fs.chmod(d,b,function(){c(d)})}};act.fs.node.is.directory=function(b,c,a){"string"==typeof a?fs.stat(a,function(a,e){null!==a?b(null!==e&&e.isDirectory()):c("[act.fs.node.is.directory] "+a.toString())}):c("[act.fs.node.is.directory] type of path "+a+" is not "+dm.Type.STRING)};act.fs.tree.read=fm.script([dm.arg.str("root"),dm.set.action(am.tree.node.has.children,act.fs.node.is.directory),dm.set.action(am.tree.node.get.children,act.fs.dir.read),am.tree.traverse]);act.fs.tree.remove=fm.script([dm.arg.str("root"),dm.set.action(am.tree.node.custom.leave,act.fs.dir.remove),am.tree.traverse]);act.fs.stream.__stream=null;act.fs.stream.create=function(b,c){return function(a,d,e){act.fs.stream.__stream=fs.createWriteStream(b,c);a()}};act.fs.stream.read=function(b,c){return function(a,d,e){var f=fs.createReadStream(e);f.on("readable",function(){for(var a;null!==(a=f.read(b));)c(fm.nop,console.log,a)});f.on("end",function(){a()});f.on("error",function(a){d("[act.fs.stream.read] "+a.toString)})}};
act.fs.stream.write=function(b,c,a){null!==act.fs.stream.__stream?(act.fs.stream.__stream.write(a),b(a)):c("[act.fs.stream.write] stream is null")};act.fs.stream.close=function(b,c,a){null!==act.fs.stream.__stream?(act.fs.stream.__stream.end(),b(a)):c("[act.fs.stream.close] stream is null")};act.fs.FileLink=function(b){this.__path=b};act.fs.FileLink.prototype.isValid=function(b,c,a){var d=this;act.fs.node.exists(function(e){e?b(a):c("[fs.FileLink] path "+d.__path+" does not exists")},c,this.__path)};act.fs.FileLink.prototype.retrieve=function(b,c,a){act.fs.file.read(b,c,this.__path)};act.fs.DirectoryLink=function(b){this.__path=b};act.fs.DirectoryLink.prototype.isValid=function(b,c,a){var d=this;act.fs.node.is.directory(function(e){e?b(a):c("[fs.DirectoryLink] path "+d.__path+" does not exists")},c,this.__path)};act.fs.DirectoryLink.prototype.retrieve=function(b,c,a){act.fs.tree.read(b,c,this.__path)};act.proc.exec=function(b){return function(c,a,d){child_process.exec(b,c,function(b,c,g){console.log(c);console.log(g);null===b?a():d("[act.proc.exec]: "+b.toString())})}};act.hash.sha1=function(b){return function(c,a,d){c(crypto.createHash("sha1").update(d).digest(b))}};module.exports = act;
